PKI Quick Installation Guide
============================
:encoding: UTF-8
:lang: en
:doctype: book

include::includes/global-attributes.asciidoc[]

About this Guide
----------------

This guide has been created to give a quick start to install the PacketFence PKI in PacketFence 5.2+. This guide does not include advanced troubleshooting of EAP-TLS connection. Refer to the documentation of EAP-TLS, RADIUS and OpenSSL for advanced features.

Assumptions
-----------

* You have at least one server with PacketFence 5.2+
* The server already has a properly configured switch with 802.1X support
* PacketFence RADIUS server is working in your environnement
* PacketFence management IP will be 192.168.1.5 and has useStrongerSecret as it's RADIUS shared secret

Installation
------------

Step 1: Install the PKI
~~~~~~~~~~~~~~~~~~~~~~~

NOTE: PacketFence PKI is available on the PacketFence repository as the package "packetfence-pki". This is available for CentOS6/7 and Debian7/8.

Installing 
^^^^^^^^^^

First of all, you will need to install the package, use the following command matching your OS.

Debian/Ubuntu:
 # sudo apt-get install packetfence-pki

CentOS/RHEL:
 # yum install packetfence-pki --enablerepo=PacketFence

Step2: Configuring the PKI
~~~~~~~~~~~~~~~~~~~~~~~~~~

PacketFence-PKI Configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

NOTE: This following configuration will allow you to generate certificates for an EAP-TLS configuration, if you want to use the PKI for another purpose you will have to adjust the Key Usage/Extended Key Usage necessary.

Now that your PKI is installed, you need to configure it.

PKI configuration
^^^^^^^^^^^^^^^^^

You will first need to log into the PKI:

* Address: https://192.168.1.5:xxx TBD
* Login: admin
* Password: packetfence

After you login there are few steps to follow to have the PKI working for an EAP-TLS configuration with PacketFence. You will need to create the following items: 

* Certificate of Authority.
* Profiles(for each purpose, i.e. Server/Client auth are 2 different profiles).
* Manual certificate generation.(for the RADIUS server)

Follow the wizard after the first login to create your Certificate of Authority.

Certificate of Authority
^^^^^^^^^^^^^^^^^^^^^^^^

image::docs/images/create-ca.png [scaledwidth="100%",alt="Certificate of Authority"]
 
+ explanation of screenshot

* Key type, size and digest: we advise to use the following RSA, 2048, sha1.
* Key Usage and Extended Key Usage are not necessary for the Certificate of Authority.
* Days: Number of validity days, i.e. 3y = 1068.

CAUTION: Remember that after the expiration date of your Certificate of Authority is passed, every certificate generated by it will not be valid anymore.

Profile
^^^^^^^

Creation of a profile:

* Name: MyClientProfile
* CA: The certificate of authority you created earlier
* Crl path: Certification revokation list path, a file will be created whith the path you add here.
* Validity: Number of validity days, i.e. 3y = 1068
* Key type, size and digest: we advise to use the following RSA, 2048, sha1
* Key Usage: Empty 
* Extended Key Usage: 
** Server certificate authentication profile: TLS Web Server Authentication, 
** Client certificate authentication profile: TLS Web Client Authentication, 

Information about Key Usage and Extended Key Usage are available from RFC5280, parts 4.2.1.3 and 4.2.1.12.

* The P12 mail setup is mandatory for the server authentication profile. This is a way to get the certificate with his password by email using the *send certificate* button. 
** If your mail alerts are already working with PacketFence you should use the following:
*** P12 smtp server: 127.0.0.1
*** Tick P12 mail password

For the header, from, subject and footer this part is the customization of the mail, it is configurable as you want it for your company. An example of value would be:

* From: pki@packetfence.pki
* Subject: Certificate for EAP-TLS connection
* Header: Below you will find your certificate and it's password to install it.
* Footer: This email has been generated automatically, please do not reply.

RADIUS server authentication certificate
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Generate a certificate from the profile you defined as the server authentication profile. This certificate will need to be installed and configured as the certificate for authenticate RADIUS.

image::docs/images/radius-profile.png [scaledwidth="100%",alt="RADIUS server certificate"]
image::docs/images/radius-profile2.png [scaledwidth="100%",alt="RADIUS server certificate"]

+ explanation of screenshot

CAUTION: We advise to use a long validity for your RADIUS server certificate to avoid renew it often(i.e. 10y).

Revokation process
^^^^^^^^^^^^^^^^^^

We have two ways to check if a certificate is valid, you can either use OCSP to interogate the PKI if the certificate is still valid, or use the revokation lists(CRL). However since the OCSP its implemented we advise you to use this method.
OSCP is scalable, its main downside would be that one request per certificate authentication is sent to the PKI to verify if the certificate is still valid.
With the CRL, everytime the CRL is updated, every equipement that uses this CRL has to download it again. For security reason we advise to have a small delay on CRL expiration(to avoid using revoked certificate on the network), but this can generate a lot of network traffic. 

Step3: Configuring PacketFence
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

PacketFence PKI
^^^^^^^^^^^^^^^

To work with our PKI in PacketFence you will need to add the PKI in the PKI_Provider section.

Click on add a new PKI and select PacketFence PKI.

Follow the instructions below to fill the PacketFence PKI configuration.

image::docs/images/packetfence-pki-provider.png [scaledwidth="100%",alt="PacketFence PKI configuration"]

+ explanation of screenshot

image::docs/images/packetfence-pki-provider2.png [scaledwidth="100%",alt="PacketFence PKI configuration"]

+ explanation of screenshot

Certificate storage on PacketFence
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
With the incomming certificate manager in future version of PacketFence, you should do the following before the installation of certificates.

 # mkdir /usr/local/pf/conf/ssl/tls_certs/

Place yourself in the folder where CA are created.

 # cd /usr/local/packetfence-pki/ca/
 # cp YourCA.pem /usr/local/pf/conf/ssl/tls_certs/
 # chown pf:pf /usr/local/pf/conf/ssl/tls_certs/*

For the RADIUS server authentication you will have 2 files, the certificate file and private key, you need both for RADIUS to work properly.

Now you can use the *send certificate* or *download certificate* to have it available. You will receive by email or in your downloads section the certificate in P12 format. You need to open it, your operating system should be able to recognize it and will ask you for a password. You have received this password by mail. After you opened it you should have 2 files in the P12 object, the certificate file and the private key, both will need to be copy into the ssl directory. 

If you use Linux or MacOS system apply the folowwing command:

 # scp /path/to/your/downloads/YourCert.* root@192.168.1.5:/usr/local/pf/conf/ssl/tls_certs/

If you use a Windows system you will need to use WinSCP to transfer over the certificate files.

When you will download or send the certificate the password will arrive by mail, if you don't receive anything you can look around to see if postfix is properly configured and you filled the information for *Mail P12* as intended.

RADIUS EAP-TLS and packetfence-pki
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Verify that all the files needed are here in the right folder, do the following command:

 # ls -l /usr/local/pf/conf/ssl/

You need to have YourCA.pem, YourCert.pem and YourCert.key.

Now we need to change FreeRADIUS configuration to allow the use of thoses certificates. To accomplish this do the following on PacketFence:

 # cd /use/local/pf
 # vi conf/radiusd/eap.conf

Now search for the tls module and modify those lines:

 # private_key_file = %%install_dir%%/conf/ssl/server.key
 # certificate_file = %%install_dir%%/conf/ssl/server.pem

in this:

 # private_key_file = %%install_dir%%/conf/ssl/tls_certs/YourCert.key
 # certificate_file = %%install_dir%%/conf/ssl/tls_certs/YourCert.pem
 # CA_file = %%install_dir%%/conf/ssl/tls_certs/YourCA.pem

When this is done you need to restart RADIUS using the following

 # bin/pfcmd service radiusd restart

Provisioners configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~

Once your pki provider is configured we will create the provisioner configuration.

Here is an example on how to configure an EAP-TLS connection for Windows/Android/MacOS/iOS

image::docs/images/eaptls-example.png [scaledwidth="100%",alt="Provisioner EAP-TLS configuration"]

+ explanation of screenshot

For MacOS/iOS you have a tab 'Signing' available, this tab will make your profile *Trusted* when trying to install on Apple device.

image::docs/images/eaptls-sign-example.png [scaledwidth="100%",alt="Signing provisioner"]

+ explanation of screenshot

Additionnal information
-----------------------

If you need any additional information for the certificate generation we advise you to use the RFC5280.
