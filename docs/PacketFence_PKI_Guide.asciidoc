PKI Quick Installation Guide
============================
:encoding: UTF-8
:lang: en
:doctype: book

include::includes/global-attributes.asciidoc[]

About this Guide
----------------

This guide has been created to give a quick start to install the PacketFence PKI in PacketFence 5.2+. This guide does not include advanced troubleshooting of EAP-TLS connection. Refer to the documentation of EAP-TLS, RADIUS and OpenSSL for advanced features.

Assumptions
-----------

* You have at least one server with PacketFence 5.2+
* The server already have a properly configured switch with 802.1X support
* PacketFence RADIUS server is working in your environnement
* PacketFence management IP will be 192.168.1.5 and has useStrongerSecret as it's RADIUS shared secret

Installation
------------

Step 1: Install the PKI
~~~~~~~~~~~~~~~~~~~~~~~

NOTE: PacketFence PKI is available on the PacketFence repository as the package "packetfence-pki". This is available for CentOS6/7 and Debian7/8.

Installing 
^^^^^^^^^^

First of all, you will need to install the package, use the following command matching your OS.

Debian/Ubuntu:
 # sudo apt-get install packetfence-pki

CentOS/RHEL:
 # yum install packetfence-pki --enablerepo=PacketFence

Step2: Configuring the PKI
~~~~~~~~~~~~~~~~~~~~~~~~~~

PacketFence-PKI Configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

NOTE: This following configuration will allow you to generate certificates for an EAP-TLS configuration, if you want to use the PKI for another purpose you will have to find the Key Usage/Extended Key Usage necessary.

Now that your PKI is installed, you need to configure it.

PKI Side
^^^^^^^^

You will first need to log into the PKI:

* Address: https://192.168.1.5:9191
* Login: admin
* Password: packetfence

After you logged in there are few steps to follow to have the PKI working for an EAP-TLS configuration with PacketFence. You will need to create the following items: 

* Certificate of Authority.
* Profiles(for each purpose, ie Server/Client auth are 2 different profiles).
* Manual certificate generation.(for the RADIUS server)

To help you out through the configuration, the first login will ask you to create a Certificate of Authority.

Certificate of Authority
^^^^^^^^^^^^^^^^^^^^^^^^
 
* Key type, size and digest: we advise to use the following RSA, 2048, sha1.
* Key Usage and Extended Key Usage can be filled if necessary, more information about Key Usage and Extended Key Usage are available from the RFC5280, parts 4.2.1.3 and 4.2.1.12.
* Days: Number of validity days, ie 3y = 1068.

CAUTION: Remember that after the expiration date of your Certificate of Authority is passed, every certificate generated by it will not be valid anymore.

Profile
^^^^^^^

Creation of a profile:

* Name: MyClientProfile
* Ca: The certificate of authority you created earlier
* Crl path: Certification revokation list path, a file will be created when you fill this.
* Validity: Number of validity days, ie 3y = 1068
* Key type, size and digest: we advise to use the following RSA, 2048, sha1
* Key Usage: Empty 
* Extended Key Usage: 
  * Server certificate authentication profile: TLS Web Server Authentication, 
  * Client certificate authentication profile: TLS Web Client Authentication, 
 Information about Key Usage and Extended Key Usage are available from RFC5280, parts 4.2.1.3 and 4.2.1.12.
* The P12 mail setup is mandatory at least for the server authentication profile. This will format the mail send with your certificate if you use *send certificate* button, to send it manually. 
  * If your mail alert are working with PacketFence you should use the following:
    *P12 smtp server: 127.0.0.1
    *tick P12 mail password
    For the header, from, subject and footer you can configure that as you please, to make the mail look like as you want it.

RADIUS server authentication certificate
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Generate a certificate from the profile you defined as the server authentication profile. This certificate will need to be installed and configured as the certificate for authenticate RADIUS. Also it will be necessary to install and trust the CA on PacketFence.

CAUTION: We advise to use a long validity for your RADIUS server certificate to avoid renew it often.

Client authentication certificate
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Generate a certificate from the profile you defined as the client authentication profile, if you generate this certificate manually you will need to use the *download certificate* or *send certificate* buttons. When the certificate is generate via PacketFence, the certificate is automatically integrated into the profile to configure the WiFi network.

Revokation process
^^^^^^^^^^^^^^^^^^

We have two ways to check if a certificate is valid, you can either use OCSP to interegote the PKI if the certificate is still valid, or use the revokation lists(CRL). However since the OCSP is implemented we advise you to use this method.
OSCP is scalable, his con would be that one request by certificate is send to the PKI to verify if this certificate is still valid.
With the CRL everytime the CRL is update every equipement capable of having this CRL has to download it again. For security reason we advise to have a small delay on CRL expiration(to avoid using revoked certificate on the network), but this can generate a lot of network traffic. 

Step3: Configuring PacketFence
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

PacketFence PKI
^^^^^^^^^^^^^^^

To work with our PKI in PacketFence you will need to add the PKI in the PKI_Provider section.

Click on add a new PKI and select PacketFence PKI.

Follow the instructions below to fill the PacketFence PKI configuration.

image::docs/images/packetfence-pki-provider.png [scaledwidth="100%",alt="PacketFence PKI configuration"]

image::docs/images/packetfence-pki-provider2.png [scaledwidth="100%",alt="PacketFence PKI configuration"]

Certificate storage on PacketFence
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
With the incomming certificate manager in future version of PacketFence, you should do the following before the installation of certificates.

 # mkdir /usr/local/pf/conf/ssl/tlscert/

Place yourself in the folder where CA are created.

 # cd /usr/local/packetfence-pki/ca/
 # mv YourCA.pem /usr/local/pf/conf/ssl/tlscert/
 # chown pf:pf /usr/local/pf/conf/ssl/tlscert/*

Download or send the RADIUS server certificate using the button on the PKI, and copy it into */usr/local/pf/conf/ssl/*. 

For the RADIUS server authentication you will have 2 files, the certificate file and private key, you need both for RADIUS to work properly so make sure you copy both in the folder */usr/local/pf/conf/ssl/*.

When you will download or send the certificate it will arrive in P12 format with the password send by mail, if you don't receive anything you can look around to see if postfix is properly configured and you filled the information for *Mail P12* as intended.

Provisioners configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~

Once your pki provider is configured we will now adapt the provisioner configuration.

Here is an example on how to configure an EAP-TLS connection for Windows/Android/MacOS/iOS

image::docs/images/eaptls-example.png [scaledwidth="100%",alt="Provisioner EAP-TLS configuration"]

For MacOS/iOS you have a tab 'signing' available, this tab will make your profile *Trusted* when trying to install on Apple device.

image::docs/images/eaptls-sign-example.png [scaledwidth="100%",alt="Signing provisioner"]

Additionnal information
-----------------------

If you need any additional information for the certificate generation we advise you to use the RFC5280.
