[% WRAPPER "class-wrapper.tt" -%]
use base qw(pf::dal);

our @FIELD_NAMES;
our @PRIMARY_KEYS;
our %DEFAULTS;
our %FIELDS_META;

BEGIN {
    @FIELD_NAMES = qw(
[% FOREACH col IN cols -%]
        [% col.COLUMN_NAME %]
[% END -%]
    );

    %DEFAULTS = (
[% FOREACH col IN cols -%]
[%- NEXT IF col.mysql_is_auto_increment -%]
        [% col.COLUMN_NAME %] => [% col.pf_default_value %],
[% END -%]
    );

    %FIELDS_META = (
[% FOREACH col IN cols -%]
        [% col.COLUMN_NAME %] => {
            type => '[% col.TYPE_NAME %]',
            is_auto_increment => [% col.mysql_is_auto_increment %],
            is_primary_key => [% IF col.mysql_is_pri_key %]1[% ELSE %]0[% END %],
        },
[% END -%]
    );

    @PRIMARY_KEYS = qw(
[% FOREACH col IN primary_keys -%]
        [% col.COLUMN_NAME %]
[% END -%]
    );
}

use Class::XSAccessor {
    accessors => \@FIELD_NAMES,
[% IF primary_keys.size > 0 %]
    true => [qw(has_primary_key)],
[% END %]
};

sub _defaults {
    return {%DEFAULTS};
}

sub field_names {
    return [@FIELD_NAMES];
}

sub primary_keys {
    return [@PRIMARY_KEYS];
}

sub table { "[% TABLE_NAME %]" }

[% IF primary_keys.size > 0 -%]
our $FIND_SQL = do {
    my $where = join(", ", map { "$_ = ?" } @PRIMARY_KEYS);
    "SELECT * FROM [% TABLE_NAME %] WHERE $where;";
};

sub _find_one_sql {
    return $FIND_SQL;
}
[% END -%]

our $UPDATE_SQL = do {
    my $where = join(", ", map { "$_ = ?" } @PRIMARY_KEYS);
    my $set = join(", ", map { "$_ = ?" } @FIELD_NAMES);
    "UPDATE [% TABLE_NAME %] SET $set WHERE $where;";
};

sub _update_sql {
    return $UPDATE_SQL;
}

sub _update_data {
    my ($self) = @_;
    my %data;
    @data{@FIELD_NAMES} = @{$self}{@FIELD_NAMES};
    return \%data;
}

sub _update_fields {
    return [@FIELD_NAMES, @PRIMARY_KEYS];
}
[%- END -%]
