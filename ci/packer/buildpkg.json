{
    "description": "Images used in CI to build packetfence packages",
    "min_packer_version": "1.4.2",
    "variables": {
        "builder_prefix": "pfbuild",
        "docker_user": "buildpkg",
        "pf_root": "../..",
        "prov_dir": "provisionners",
        "files_dir": "files",
        "tmp_dir": "/tmp",
        "go_version": "go1.9.3",
        "go_path": "/root/go",
        "go_repo": "github.com/inverse-inc/packetfence",
        "go_extra_path": "go",
        "go_vendor_dir": "{{user `go_extra_path`}}/vendor",
        "image_version": "0.0.3"
    },
    "builders": [
        {
            "name": "{{user `builder_prefix`}}-centos-7",
            "type": "docker",
            "image": "{{user `docker_user`}}/centos:7",
            "run_command": ["-d", "-i", "-t", "--", "{{.Image}}"],
            "commit": true,
            "changes": [
                "ENV GOPATH {{user `go_path`}}",
                "ENV PATH /usr/local/go/bin:$PATH",
                "ENV GO_REPO $GOPATH/{{user `go_repo`}}/{{user `go_extra_path`}}"
            ]
        },
        {
            "name": "{{user `builder_prefix`}}-stretch",
            "type": "docker",
            "image": "{{user `docker_user`}}/debian:stretch",
            "run_command": ["-d", "-i", "-t", "--", "{{.Image}}"],
            "commit": true,
            "changes": [
                "ENV GOPATH {{user `go_path`}}",
                "ENV PATH /usr/local/go/bin:$PATH",
                "ENV GO_REPO $GOPATH/{{user `go_repo`}}/{{user `go_extra_path`}}"
            ]
        },
        {
            "name": "{{user `builder_prefix`}}-buster",
            "type": "docker",
            "image": "{{user `docker_user`}}/debian:buster",
            "run_command": ["-d", "-i", "-t", "--", "{{.Image}}"],
            "commit": true,
            "changes": [
                "ENV GOPATH {{user `go_path`}}",
                "ENV PATH /usr/local/go/bin:$PATH",
                "ENV GO_REPO $GOPATH/{{user `go_repo`}}/{{user `go_extra_path`}}"
            ]
        }
    ],
    "provisioners": [
        {
            "type": "ansible",
            "playbook_file": "{{user `prov_dir`}}/site.yml",
            "galaxy_file": "{{user `prov_dir`}}/requirements.yml",
            "inventory_directory": "{{user `prov_dir`}}/inventory",
            "groups": ["centos"],
            "only": ["{{user `builder_prefix`}}-centos-7"]
        },
        {
            "type": "ansible",
            "playbook_file": "{{user `prov_dir`}}/site.yml",
            "galaxy_file": "{{user `prov_dir`}}/requirements.yml",
            "inventory_directory": "{{user `prov_dir`}}/inventory",
            "groups": ["debian"],
            "only": ["{{user `builder_prefix`}}-stretch",
                     "{{user `builder_prefix`}}-buster"
                    ]
        },
        {
            "type": "file",
            "source": "{{user `pf_root`}}/rpm",
            "destination": "{{user `tmp_dir`}}",
            "only": ["{{user `builder_prefix`}}-centos-7"]
        },
        {
            "type": "file",
            "source": "{{user `pf_root`}}/debian",
            "destination": "{{user `tmp_dir`}}",
            "only": ["{{user `builder_prefix`}}-stretch",
                     "{{user `builder_prefix`}}-buster"
                    ]
        },
        {
            "type": "shell",
            "inline": ["curl -s https://gitlab.com/Orange-OpenSource/gitlab-buildpkg-tools/merge_requests/8.diff | git apply -v -p2 -",
                       "ci-build-pkg {{user `tmp_dir`}}"
                      ],
            "environment_vars": ["CI_BUILDPKG_DEP_ONLY=yes",
                                 "CI_COMMIT_REF_NAME=fakebranch"
                                ]
        },
        {
            "type": "shell",
            "inline": ["yum clean all"],
            "only": ["{{user `builder_prefix`}}-centos-7"]
        },
        {
            "type": "shell",
            "inline": ["apt-get clean"],
            "only": ["{{user `builder_prefix`}}-stretch",
                     "{{user `builder_prefix`}}-buster"
                    ]
        },
        {
            "type": "shell",
            "script": "{{user `pf_root`}}/addons/dev-helpers/setup-go-env.sh",
            "environment_vars": ["GOVERSION={{user `go_version`}}",
                                 "GOPATH={{user `go_path`}}",
                                 "GO_REPO={{user `go_repo`}}/{{user `go_extra_path`}}"
                                ]

        },
        {
            "type": "file",
            "source": "{{user `pf_root`}}/{{user `go_vendor_dir`}}",
            "destination": "{{user `go_path`}}/src/{{user `go_repo`}}/{{user `go_vendor_dir`}}"
        },
        {
            "type": "shell",
            "script": "{{user `prov_dir`}}/install-go-dependencies.sh",
            "environment_vars": ["GOPATH={{user `go_path`}}",
                                 "GO_REPO={{user `go_repo`}}",
                                 "EXTRA_PATH={{user `go_extra_path`}}"
                                ]
        }
    ],
    "post-processors": [
        {
            "type": "docker-tag",
            "only": ["{{user `builder_prefix`}}-centos-7"],
            "repository": "inverseinc/{{user `builder_prefix`}}-centos-7",
            "tag": "{{user `image_version`}}"
        },
        {
            "type": "docker-tag",
            "only": ["{{user `builder_prefix`}}-stretch"],
            "repository": "inverseinc/{{user `builder_prefix`}}-debian-stretch",
            "tag": "{{user `image_version`}}"
        },
        {
            "type": "docker-tag",
            "only": ["{{user `builder_prefix`}}-buster"],
            "repository": "inverseinc/{{user `builder_prefix`}}-debian-buster",
            "tag": "{{user `image_version`}}"
        },
        {
            "type": "docker-push",
            "login": true
        }
    ]
}
