name: Check firewall sso mock history
testcases:

- name: install_jq
  steps:
  - type: exec
    script: |
     sudo apt-get -y install jq

- name: install_pip
  steps:
  - type: exec
    script: |
     sudo apt-get -y install pip

- name: install_yq
  steps:
  - type: exec
    script: |
     sudo pip install yq

- name: check_mock_history_request
  steps:
  - type: exec
    script: |
      curl http://{{.firewall_sso.firewall.host}}:{{.firewall_sso.firewall.port_config}}/history | jq '.[-1].request'
    assertions:
      - result.systemoutjson.path ShouldEqual "/api/"
      - result.systemoutjson.method ShouldEqual "POST"
      - result.systemoutjson.query_params.key ShouldContain "{{.firewall_sso.firewall.password}}"

- name: check_mock_history_request_body_string
  steps:
  - type: exec
    script: |
      curl http://{{.firewall_sso.firewall.host}}:{{.firewall_sso.firewall.port_config}}/history | jq -r '.[-1].request.body' | cut -d '=' -f 2  | sed 's/\+/%20/g'| sed -e "s/%\([0-9A-F][0-9A-F]\)/\\\\\x\1/g" | xargs -0 echo -e | xq .
    assertions:
      - result.systemoutjson.uid-message.payload.login.entry.@name ShouldEqual "{{.ad_domain_user}}"

