name: Create and test AD machine source
testcases:
#
# Need bug fixed before doing an executor
# https://github.com/ovh/venom/issues/493
# https://github.com/ovh/venom/issues/425
#
- name: create_ad_machine_source
  steps:
  - type: pf_api_action
    method: POST
    url: "config/sources"
    status_code: 201
    body: >-
      {
        "administration_rules": null,
        "authentication_rules": [
          {
            "id": "catchall",
            "description": null,
            "match": "all",
            "actions": [
              {
                "type": "set_role",
                "value": "{{.dot1x_eap_peap.roles.ad_machine.id}}"
              },
              {
                "type": "set_access_duration",
                "value": "{{.dot1x_eap_peap.sources.ad_machine.access_duration}}"
              }
            ],
            "conditions": []
          } 
        ],
        "basedn": "{{.ad_base_dn}}",
        "binddn": "{{.ad_domain_admin_user}}@{{.ad_dns_domain}}",
        "cache_match": "0",
        "connection_timeout": 1,
        "description": "{{.dot1x_eap_peap.sources.ad_machine.description}}",
        "email_attribute": "mail",
        "encryption": "starttls",
        "host": [
          "{{.ad_mgmt_ip}}"
        ],
        "id": "{{.dot1x_eap_peap.sources.ad_machine.name}}",
        "monitor": "1",
        "password": "{{.ad_domain_admin_password}}",
        "port": "389",
        "read_timeout": 10,
        "realms": "",
        "scope": "sub",
        "searchattributes": "",
        "set_access_durations_action": null,
        "shuffle": "0",
        "type": "AD",
        "usernameattribute": "sAMAccountName",
        "verify": "none",
        "client_cert_file": "",
        "client_key_file": "",
        "ca_file": "",
        "write_timeout": 5
      }

- name: test_ad_machine_source
  steps:
  - type: pf_api_action
    method: POST
    url: "config/sources/test"
    status_code: 200
    body: >-
      {
        "basedn": "{{.ad_base_dn}}",
        "binddn": "{{.ad_domain_admin_user}}@{{.ad_dns_domain}}",
        "connection_timeout": 1,
        "description": "{{.dot1x_eap_peap.sources.ad_machine.description}}",
        "encryption": "starttls",
        "host": [
          "{{.ad_mgmt_ip}}"
        ],
        "id": "{{.dot1x_eap_peap.sources.ad_machine.name}}",
        "password": "{{.ad_domain_admin_password}}",
        "port": "389",
        "read_timeout": 10,
        "scope": "sub",
        "type": "AD",
        "usernameattribute": "sAMAccountName",
        "verify": "none",
        "client_cert_file": "",
        "client_key_file": "",
        "ca_file": "",
        "write_timeout": 5
      }
    retry: 3
    delay: 5
